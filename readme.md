## l2tp协议分析

同济大学 2020级 信息安全原理 课程作业（Project 1）。

差不多算是做完了罢......笑得，第三问代码有点搞笑。

有时间的话再迭代，没时间就算了，另外准备写一个针对这次作业的教程。

**以后再说。**



### 作业题目

基于C++设计并实现一个简单系统，实现：

（1）基于windows或linux抓取l2tp协议流量；

（2）针对每一个目标用户，实时监控其l2tp请求，并分析、还原、呈现其连接和业务载荷；

（3）支持对特定目标的静载荷替换。

构建一个demo：用笔记本电脑实现对手机上网对象的以上功能。

### 解题方案

#### 1. 基于windows或linux抓取l2tp协议流量

我们基于windows10系统和阿里云服务器（CentOS），搭建了能够抓取l2tp协议流量的服务端和电脑环境。在服务端，使用l2tp over IpSec协议，开放1701端口和4500端口，在windows系统，通过修改注册表和管理策略，禁用IpSec功能，使得协议流量均为未加密的l2tp协议流量，便于后续实验分析。编写C++程序，并配置使用WinPcap4.1.3，抓取协议流量。

同时，通过观察对比实验，验证了第一问的正确性。

#### 2. 针对每一个目标用户，实时监控其l2tp请求，并分析、还原、呈现其连接和业务载荷

首先，我们实时监控了手机的l2tp请求。由于手机无法禁用IpSec功能，因此通过l2tp over IpSec协议与服务端进行数据交换，通过抓取其数据包，使用的端口为4500，证明了其为加密过的报文。

为了进一步拆解l2tp请求数据，我们使用另一台电脑模拟手机环境，在该电脑同样禁用IpSec，这两台电脑通过热点相互连接，并使用l2tp vpn，使得能够对目标用户的l2tp请求拆解，分析、还原并呈现其连接和业务载荷，包括类型、长度在位标志、顺序字段在位标志、偏移值在位标志、优先级、版本号、消息总长度、隧道标识符、会话标识符、当前消息顺序号、下一消息顺序号、偏移量等信息。

我们也拆解并分析了更高层次的以太网协议、Ipv4协议和UDP协议，详细呈现了其连接和业务载荷。

同时，通过wireshark抓取数据包的对比，验证了第二问的正确性。

#### 3. 支持对特定目标的静载荷替换

我们通过对l2tp报文封装结构的分析，找到数据包的静载荷部分，并将特定数据包的静载荷替换为自己的data数据，替换完成后，再按照l2tp报文结构进行封装，产生一个新的数据包。

同时，使用第2问的拆解算法，对新的数据包重新拆解，得到了我们替换的新静载荷。
